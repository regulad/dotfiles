# this file is sourced by both zsh and bash; should use common syntax
if [ "$(uname -o)" = "Darwin" ]; then
    if [ -n "$ZSH_VERSION" ]; then
        autoload -Uz colors && colors
        setopt promptsubst
    fi

    if [ "$(arch)" = "arm64" ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"

        export PNPM_HOME="/Users/regulad/Library/pnpm"

        export NVM_DIR="$HOME/.nvm"
        [ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
        [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion
    else
        eval "$(/usr/local/bin/brew shellenv)"
    fi

    export ANDROID_HOME="/Users/regulad/Library/Android/sdk"

    # The following lines have been added by Docker Desktop to enable Docker CLI completions.
    fpath=(/Users/regulad/.docker/completions $fpath)
    if [ -n "$ZSH_VERSION" ]; then
        autoload -Uz compinit && compinit
    fi
    # End of Docker CLI completions
elif [ "$(uname -o)" = "GNU/Linux" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

if [ "$(uname -s)" = "Linux" ]; then
    export PNPM_HOME="$HOME/.local/share/pnpm"
fi

if [[ -f /etc/os-release ]]; then
  . /etc/os-release
  if [[ "$ID" == "ubuntu" ]]; then
    # Add snap bin directories to PATH if they exist
    [[ -d /snap/bin ]] && export PATH="/snap/bin:$PATH"
    [[ -d /var/lib/snapd/snap/bin ]] && export PATH="/var/lib/snapd/snap/bin:$PATH"
  fi
fi

# pnpm
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end

# Created by `pipx` on 2025-08-15 00:48:24
export PATH="$PATH:$HOME/.local/bin"

# cargo on rustup systems
if [ -n "$(command -v rustup-init)" ]; then
    . "$HOME/.cargo/env"
fi

# gpg daemon
export GPG_TTY=$(tty)

# ssh daemon
unset _bw_sock
case "$(uname -o)" in
  Android)
    # https://github.com/termux/termux-packages/blob/master/packages/openssh/sv/ssh-agent.run.in#L3-L7
    export SSH_AUTH_SOCK="$PREFIX"/var/run/ssh-agent.socket
    ;;
  Darwin)
    for _bw_sock in \
      "$HOME/.bitwarden-ssh-agent.sock" \
      "$HOME/Library/Containers/com.bitwarden.desktop/Data/.bitwarden-ssh-agent.sock"
    do
      [ -S "$_bw_sock" ] && export SSH_AUTH_SOCK="$_bw_sock" && break
    done
    ;;
  GNU/Linux)
    for _bw_sock in \
      "$HOME/.bitwarden-ssh-agent.sock" \
      "$HOME/snap/bitwarden/current/.bitwarden-ssh-agent.sock" \
      "$HOME/.var/app/com.bitwarden.desktop/data/.bitwarden-ssh-agent.sock"
    do
      [ -S "$_bw_sock" ] && export SSH_AUTH_SOCK="$_bw_sock" && break
    done
    ;;
esac

if [ -z "${SSH_AUTH_SOCK:-}" ] || [ ! -S "${SSH_AUTH_SOCK:-}" ]; then
  if command -v keychain >/dev/null 2>&1; then
    eval "$(keychain --eval --quiet --noask)"
  else
    echo "warning: no Bitwarden SSH agent socket found, and keychain is not installed; SSH_AUTH_SOCK not set" >&2
  fi
fi

unset _bw_sock

# completions
if [ -n "$ZSH_VERSION" ]; then
    eval "$(chezmoi completion zsh)"
else
    eval "$(chezmoi completion bash)"
fi

# Preferences
alias pipx="uv tool"
export DO_NOT_TRACK=1
export VISUAL="$(command -v nvim || command -v vim)"

# === ALIASES
vi() { command "$VISUAL" "$@"; }
if [ -n "${ZSH_VERSION-}" ]; then
  case "$VISUAL" in
    *nvim) compdef vi=nvim ;;
    *vim)  compdef vi=vim  ;;
  esac
fi

ssh-privpub() {
    for key in "$@"; do
        [[ "$key" == *.pub ]] && continue
        [ -f "$key" ] && ssh-keygen -y -f "$key" > "${key}.pub" 2>/dev/null && echo "${key}.pub"
    done
}
[ -n "$ZSH_VERSION" ] && compdef _files ssh-privpub

chezmoi-cd() {
    cd $(chezmoi source-path)
}
