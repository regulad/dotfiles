base:
  - template:ubuntu-lts
cpus: 2
memory: "4GiB"
disk: "20GiB"
user:
  name: "regulad"
  uid: 1000
  home: "/home/regulad"
mountInotify: true
mounts:
  - location: "~/repositories"
    mountPoint: "/home/regulad/repositories"
    writable: true
  - location: "~/.secrets"
    mountPoint: "/tmp/.secrets"
    writable: false
  - location: "/tmp/.supersecrets"
    mountPoint: "/tmp/.supersecrets"
    writable: false
  - location: "~/.cache"
    mountPoint: "/home/regulad/.cache"
    writable: true
provision:
  - mode: user
    script: |
      #!/usr/bin/env bash
      exec >>/tmp/.provision.log 2>&1
      set -eu

      export DEBIANFRONTEND=noninteractive
      export NONINTERACTIVE=1

      GITHUB_USERNAME=regulad

      sudo apt update
      sudo apt install -y zsh
      sudo apt upgrade -y
      sudo apt autoremove -y

      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

      # bootstrap
      brew install \
        chezmoi \
        bitwarden-cli

      # umount as soon as we are done
      . /tmp/.secrets/.bwrc

      bw config server https://vw.regulad.xyz
      bw login --apikey
      export BW_SESSION=$(bw unlock --raw --passwordfile /tmp/.supersecrets/.bwpasswd)

      sudo umount /tmp/.secrets
      sudo umount /tmp/.supersecrets

      # time to let er' rip
      chezmoi init $GITHUB_USERNAME
      chezmoi apply
