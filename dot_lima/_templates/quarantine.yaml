base:
  - template:ubuntu-lts
cpus: 2
memory: "4GiB"
disk: "20GiB"
user:
  name: "regulad"
  uid: 1000
  home: "/home/regulad"
mounts:
  - location: "~/repositories"
    mountPoint: "/home/regulad/repositories"
    writable: true
  - location: "~/.bwrc"
    mountPoint: "/tmp/.bwrc"
    writable: false
provision:
  - mode: user
    script: |
      #!/usr/bin/env bash
      exec >>/tmp/.provision.log 2>&1
      set -eu

      export DEBIANFRONTEND=noninteractive
      export NONINTERACTIVE=1

      GITHUB_USERNAME=regulad

      sudo apt update
      sudo apt install -y zsh
      sudo apt upgrade -y
      sudo apt autoremove -y

      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

      # bootstrap
      brew install \
        chezmoi \
        bitwarden-cli

      . /tmp/.bwrc

      bw config server https://vw.regulad.xyz
      bw login --apikey

      chezmoi init $GITHUB_USERNAME
      chezmoi apply -x templates

      # TODO: how should we unlock the vault without passing a valuable secret into the environment?
      # export BW_SESSION=$(bw unlock --raw)
      # chezmoi apply
