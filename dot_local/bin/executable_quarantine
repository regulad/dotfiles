#!/usr/bin/env bash
set -euo pipefail

yaml="$HOME/.lima/_templates/quarantine.yaml"
[[ -f "$yaml" ]] || {
	echo "missing: $yaml" >&2
	exit 1
}

name="quarantine-$(date +%Y%m%d-%H%M%S)-$$"
fixed_home="/home/regulad"
pwd_fixed=${PWD/#"$HOME"/"$fixed_home"}
log_level="info"

mkdir "/tmp/.supersecret"
chmod "600" "/tmp/.supersecret"

cleanup() {
	limactl --log-level=$log_level delete -f "$name" >/dev/null 2>&1 || true
	# can't figure out a better alternative than just creating a directory like this

}
trap cleanup EXIT

limactl --log-level=$log_level create --tty=false --name "$name" "$yaml"
limactl --log-level=$log_level shell --start --shell=/bin/zsh "$name"
