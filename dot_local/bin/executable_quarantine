#!/usr/bin/env bash
set -euo pipefail

yaml="$HOME/.lima/_templates/quarantine.yaml"
[[ -f "$yaml" ]] || {
	echo "missing: $yaml" >&2
	exit 1
}

name="quarantine-$(date +%Y%m%d-%H%M%S)-$$"
fixed_home="/home/regulad"
pwd_fixed=${PWD/#"$HOME"/"$fixed_home"}
log_level="info"

# need to unlock the vault for the quarantine to read temporarily
mkdir "/tmp/.supersecrets"
chmod "700" "/tmp/.supersecrets"
printf 'export BW_SESSION="%s"\n' "${BW_SESSION:-$(bw unlock --raw)}" >/tmp/.supersecrets/.bwsession
chmod "400" /tmp/.supersecrets/.bwsession

cleanup() {
	limactl --log-level=$log_level delete -f "$name" >/dev/null 2>&1 || true
	rm -rf "/tmp/.supersecrets"
}
trap cleanup EXIT

limactl --log-level=$log_level create --tty=false --name "$name" "$yaml"
limactl --log-level=$log_level shell --start --shell=/bin/zsh "$name"
