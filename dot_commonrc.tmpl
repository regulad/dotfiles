# THIS FILE IS MANAGED BY CHEZMOI!

# needed for Android native builds
if [ "$(uname -o)" = "Android" ]; then
  export ANDROID_API_LEVEL="$(getprop ro.build.version.sdk 2>/dev/null || true)"
fi

# this file is sourced by both zsh and bash; should use common syntax
if [ "$(uname -o)" = "Darwin" ]; then
    if [ -n "$ZSH_VERSION" ]; then
        autoload -Uz colors && colors
        setopt promptsubst
    fi

    if [ "$(arch)" = "arm64" ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"

        export PNPM_HOME="/Users/regulad/Library/pnpm"

        export NVM_DIR="$HOME/.nvm"
        [ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
        [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion
    else
        eval "$(/usr/local/bin/brew shellenv)"
    fi
    export PATH="$(brew --prefix ruby)/bin:$PATH"
    export PATH="$HOMEBREW_PREFIX/lib/ruby/gems/4.0.0/bin:$PATH"

    export ANDROID_HOME="$HOME/Library/Android/sdk"
    export ANDROID_SDK_ROOT="$HOME/Library/Android/sdk"

    # The following lines have been added by Docker Desktop to enable Docker CLI completions.
    fpath=(/Users/regulad/.docker/completions $fpath)
    if [ -n "$ZSH_VERSION" ]; then
        autoload -Uz compinit && compinit
    fi
    # End of Docker CLI completions
elif [ "$(uname -o)" = "GNU/Linux" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    export PATH="$(brew --prefix ruby)/bin:$PATH"
    export PATH="$HOMEBREW_PREFIX/lib/ruby/gems/4.0.0/bin:$PATH"

    export ANDROID_HOME="$HOME/Android/sdk"
    export ANDROID_SDK_ROOT="$HOME/Android/sdk"
fi

# sdkmanager-managed sdkmanager overrides brew-managed sdkmanager
export PATH=$ANDROID_HOME/platform-tools:$PATH
export PATH=$ANDROID_HOME/tools:$PATH

if [ "$(uname -s)" = "Linux" ]; then
    export PNPM_HOME="$HOME/.local/share/pnpm"
fi

if [[ -f /etc/os-release ]]; then
  . /etc/os-release
  if [[ "$ID" == "ubuntu" ]]; then
    # Add snap bin directories to PATH if they exist
    [[ -d /snap/bin ]] && export PATH="/snap/bin:$PATH"
    [[ -d /var/lib/snapd/snap/bin ]] && export PATH="/var/lib/snapd/snap/bin:$PATH"
  fi
fi

# Set browser to wslview if in WSL
if grep -qi wsl /proc/version 2>/dev/null; then
    export BROWSER=wslview
fi

# pnpm
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end

# deno
export DENO_INSTALL="$HOME/.deno"
export PATH="$DENO_INSTALL/bin:$PATH"
# deno end

# Created by `pipx` on 2025-08-15 00:48:24
export PATH="$PATH:$HOME/.local/bin"

# cargo on rustup systems
if [ -n "$(command -v rustup-init)" ]; then
    . "$HOME/.cargo/env"
fi

# gpg daemon
export GPG_TTY=$(tty)

# ssh daemon
unset _bw_sock
case "$(uname -o)" in
  Android)
    # https://github.com/termux/termux-packages/blob/master/packages/openssh/sv/ssh-agent.run.in#L3-L7
    export SSH_AUTH_SOCK="$PREFIX"/var/run/ssh-agent.socket
    ;;
  Darwin)
    for _bw_sock in \
      "$HOME/.bitwarden-ssh-agent.sock" \
      "$HOME/Library/Containers/com.bitwarden.desktop/Data/.bitwarden-ssh-agent.sock"
    do
      [ -S "$_bw_sock" ] && export SSH_AUTH_SOCK="$_bw_sock" && break
    done
    ;;
  GNU/Linux)
    for _bw_sock in \
      "$HOME/.bitwarden-ssh-agent.sock" \
      "$HOME/snap/bitwarden/current/.bitwarden-ssh-agent.sock" \
      "$HOME/.var/app/com.bitwarden.desktop/data/.bitwarden-ssh-agent.sock"
    do
      [ -S "$_bw_sock" ] && export SSH_AUTH_SOCK="$_bw_sock" && break
    done
    ;;
esac

if [ -z "${SSH_AUTH_SOCK:-}" ] || [ ! -S "${SSH_AUTH_SOCK:-}" ]; then
  if command -v keychain >/dev/null 2>&1; then
    eval "$(keychain --eval --quiet --noask)"
  else
    echo "warning: no Bitwarden SSH agent socket found, and keychain is not installed; SSH_AUTH_SOCK not set" >&2
  fi
fi

unset _bw_sock

# completions
if [ -n "$ZSH_VERSION" ]; then
    eval "$(chezmoi completion zsh)"
    eval "$(fabric completions zsh)"
else
    eval "$(chezmoi completion bash)"
    eval "$(fabric completions bash)"
fi

# Preferences
export OLLAMA_HOST="{{- .ollamaBase -}}"
alias pipx="uv tool"
export DO_NOT_TRACK=1
export HOMEBREW_NO_ENV_HINTS=1
export VISUAL="$(command -v nvim || command -v vim)"

# === ALIASES
alias pycalc3="uv run --directory=$HOME/.local/share/pycalc3 ipython --no-banner -i --profile=default"
alias c3="pycalc3"
alias wakaru="pnpm dlx @wakaru/cli"

vi() { command "$VISUAL" "$@"; }
if [ -n "${ZSH_VERSION-}" ]; then
  case "$VISUAL" in
    *nvim) compdef vi=nvim ;;
    *vim)  compdef vi=vim  ;;
  esac
fi

ssh-privpub() {
    for key in "$@"; do
        [[ "$key" == *.pub ]] && continue
        [ -f "$key" ] && ssh-keygen -y -f "$key" > "${key}.pub" 2>/dev/null && echo "${key}.pub"    
    done
}
[ -n "$ZSH_VERSION" ] && compdef _files ssh-privpub

chezmoi-cd() {
    cd $(chezmoi source-path)
}

# === ANNOUNCEMENTS/psuedoMOTD
LAST_SYNC="{{ now | date "2006-01-02" }}"
DAYS_OLD=$(( ( $(date +%s) - $(date -j -f "%Y-%m-%d" "$LAST_SYNC" +%s 2>/dev/null || date -d "$LAST_SYNC" +%s) ) / 86400 ))

if [ "$DAYS_OLD" -gt 7 ]; then
    echo "warning: last chezmoi sync was $LAST_SYNC, resync soon" >&2
fi

fastfetch
